# --- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: è¦‹ç©æ›¸PDFã‹ã‚‰æƒ…å ±æŠ½å‡º ---
st.markdown('<div class="section-header">ğŸ“„ 3. è¦‹ç©æ›¸PDFã‹ã‚‰æƒ…å ±æŠ½å‡º</div>', unsafe_allow_html=True)

st.markdown('<div class="info-box">ğŸ’¡ ä¿é™ºä¼šç¤¾ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸè¦‹ç©æ›¸PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æƒ…å ±ã‚’æŠ½å‡ºã—ã¦æ¯”è¼ƒè¡¨ã«è¿½åŠ ã—ã¾ã™ã€‚</div>', unsafe_allow_html=True)

# ãƒ•ã‚©ãƒ«ãƒ€å‡¦ç†ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
st.subheader("ãƒ•ã‚©ãƒ«ãƒ€å†…ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬å‡¦ç†")
folder_path = st.text_input(
    "PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‚’å…¥åŠ›",
    placeholder="ä¾‹: C:/Users/YourName/Documents/PDFs ã¾ãŸã¯ /home/user/pdfs",
    help="Windowså½¢å¼ (C:\\Users\\...) ã§ã‚‚ Linux å½¢å¼ (/home/...) ã§ã‚‚å…¥åŠ›ã§ãã¾ã™"
)

if folder_path:
    if st.button("ãƒ•ã‚©ãƒ«ãƒ€å†…ã®PDFã‚’å‡¦ç†", key="process_folder"):
        normalized_path = os.path.normpath(folder_path).replace("\\", "/")
        st.info(f"å‡¦ç†ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€: {normalized_path}")
        
        if os.path.exists(normalized_path):
            if os.path.isdir(normalized_path):
                with st.spinner("ãƒ•ã‚©ãƒ«ãƒ€å†…ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­..."):
                    pdf_files = []
                    # å¤§æ–‡å­—å°æ–‡å­—ä¸¡æ–¹ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
                    for ext in ["*.pdf", "*.PDF"]:
                        pdf_files.extend(glob.glob(os.path.join(normalized_path, ext)))
                    
                    if not pdf_files:
                        st.warning(f"ãƒ•ã‚©ãƒ«ãƒ€ {normalized_path} ã«PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
                    else:
                        results = []
                        progress_bar = st.progress(0)
                        for idx, pdf_file in enumerate(pdf_files):
                            try:
                                with open(pdf_file, "rb") as f:
                                    pdf_bytes = f.read()
                                extracted_info_str = extract_insurance_info_with_gemini_vision(pdf_bytes)
                                
                                if isinstance(extracted_info_str, str):
                                    if extracted_info_str.startswith("```json") and extracted_info_str.endswith("```"):
                                        extracted_info_str = extracted_info_str[len("```json\n"):-len("\n```")]
                                    extracted_info = json.loads(extracted_info_str)
                                    results.append(extracted_info)
                                    st.success(f"âœ… {os.path.basename(pdf_file)} ã®å‡¦ç†ãŒå®Œäº†")
                                
                            except Exception as e:
                                st.error(f"âŒ {os.path.basename(pdf_file)} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: {str(e)}")
                            
                            progress_bar.progress((idx + 1) / len(pdf_files))
                        
                        if results:
                            st.success(f"{len(results)} ä»¶ã®PDFã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã—ãŸ")
                            # æ¯”è¼ƒè¡¨ã«è¿½åŠ 
                            for result in results:
                                new_quote_data = {
                                    "æ°å": result.get("æ°å", ""),
                                    "ç”Ÿå¹´æœˆæ—¥": result.get("ç”Ÿå¹´æœˆæ—¥", ""),
                                    "ä¿é™ºä¼šç¤¾å": result.get("ä¿é™ºä¼šç¤¾å", ""),
                                    "ä¿é™ºæœŸé–“": result.get("ä¿é™ºæœŸé–“", ""),
                                    "ä¿é™ºé‡‘é¡": result.get("ä¿é™ºé‡‘é¡", ""),
                                    "è£œå„Ÿå†…å®¹": result.get("è£œå„Ÿå†…å®¹", "")
                                }
                                st.session_state["comparison_df"] = pd.concat(
                                    [st.session_state["comparison_df"], 
                                     pd.DataFrame([new_quote_data])], 
                                    ignore_index=True
                                )
            else:
                st.error("æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ã¯ãƒ•ã‚©ãƒ«ãƒ€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
        else:
            st.error("æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚æ­£ã—ã„ãƒ‘ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# æ—¢å­˜ã®è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼éƒ¨åˆ†ã¯ç¶­æŒ
st.markdown("---")
st.subheader("ã¾ãŸã¯ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
# ... æ—¢å­˜ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚³ãƒ¼ãƒ‰ ...